<!DOCTYPE html>
<html lang="en">
<head>
  <title>CRUD App</title>
  <meta name="description" content="Create, read, update, delete data tables.">
  <meta name="author" content="Jordan Mitchell Barrett">

  <link rel="stylesheet" href="style.css">
  <script src="server.js"></script>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body onload="getTables()">
  <main>
    <h1>Hello there!</h1>
    <button onclick="runTest()">Test API</button>

    <h2>Make/view table</h2>
    <p>Table name:</p>
    <input type="text" id="tablename">
    <p>Table password (optional):</p>
    <input type="password" id="tablepwd">
    <button onclick="makeTable()" id="maketable">Create table</button>
    <button onclick="viewTable()" id="viewtable">View table</button>
    <button onclick="deleteTable()" id="deletetable">Delete table</button>
    <div id="tableDisplay"></div>

    <h2>Existing tables</h2>
    <button onclick="getTables()">Update</button>
    <button onclick="reset()">Delete all data</button>
    <div id="masterTable"></div>

    <script>
      // Get server address
      // Checks if LOCAL_SERVER is defined in server.js, otherwise default to external server
      SERVER = LOCAL_SERVER ? LOCAL_SERVER : 'https://barrettj12-crud-app.herokuapp.com'

      // Get page elements
      nameInput = document.getElementById('tablename')
      pwdInput = document.getElementById('tablepwd')
      tableDisplay = document.getElementById('tableDisplay')
      masterTable = document.getElementById('masterTable')


      // API test
      async function runTest() {
        fetch(SERVER + '/test')
          .then(resp => resp.text())
          .then(msg => alert(msg))
          .catch(err => handleError(err))
      }

/*      function processMessage(message) {
        fmessage = 'New message from server: "' + message + '"'
        alert(fmessage)
        console.log(fmessage)
      }*/


      // Make new table
      async function makeTable() {
        const formData = new FormData()
        formData.append('name', nameInput.value)
        formData.append('pwd', pwdInput.value)

        fetch(SERVER + '/maketable', {
          method: 'POST',
          body: formData
        })
          .then(resp => resp.text())
          .then(msg => { getTables(); alert(msg) })
          .catch(err => handleError(err))
      }

      // View table
      async function viewTable() {
        fetch(SERVER + '/viewtable?name=' + nameInput.value, {
          headers: {
            'Authorization': pwdInput.value
          }
        })
          .then(resp => {
            if (resp.ok) {
              resp.json()
//                .then(data => console.log(data))
                .then(data => formatTable(data))
                .then(elmt => tableDisplay.replaceChildren(elmt))
            }
            else {
              resp.text().then(msg => alert(msg))
            }
          })
          .catch(err => handleError(err))
      }

      // Delete table
      async function deleteTable() {
        fetch(SERVER + '/deletetable?name=' + nameInput.value, {
          headers: {
            'Authorization': pwdInput.value
          }
        })
          .then(resp => resp.text())
          .then(msg => { getTables(); alert(msg) })
          .catch(err => handleError(err))
      }


      // Format received JSON table as HTML table
      // Returns an HTMLTableElement
      function formatTable(tableData) {
        const table = document.createElement('table')

        // Make headers
        headerRow = document.createElement('tr')

        for (hdText of tableData.fields) {
          colHeader = document.createElement('th')
          hdNode = document.createTextNode(hdText)
          colHeader.appendChild(hdNode)
          headerRow.appendChild(colHeader)
        }

        table.appendChild(headerRow)

        // Make rows
        for (rowData of tableData.data) {
          nextRow = document.createElement('tr')

          for (txt of rowData) {
            cell = document.createElement('td')
            txtNode = document.createTextNode(txt == null ?'' : txt)
            cell.appendChild(txtNode)
            nextRow.appendChild(cell)
          }

          table.appendChild(nextRow)
        }

        return table;
      }

      //

      // Error handling for fetch
      function handleError(err) {
        alert('Whoops, an error occurred.')
        console.log(err)
      }


      // Get tables
      async function getTables() {
        fetch(SERVER + '/tables')
          .then(resp => {
            console.log(resp)
            if (resp.ok) {
              resp.json()
//                .then(data => console.log(data))
                .then(data => formatTable(data))
                .then(elmt => masterTable.replaceChildren(elmt))
            }
            else {
              resp.text().then(msg => alert(msg))
            }
          })
          .catch(err => handleError(err))
      }

      // Reset ALL data
      async function reset() {
        if (window.confirm('Are you sure you want to delete all data?')) {
          fetch(SERVER + '/reset')
            .then(resp => resp.text())
            .then(msg => { getTables(); alert(msg) })
            .catch(err => handleError(err))
        }
      }
    </script>
  </main>
</body>
</html>